<?xml version="1.0" encoding="UTF-8" ?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Add_Log_Entry_for_Error</name>
        <label>Add Log Entry for Error</label>
        <locationX>1018</locationX>
        <locationY>1130</locationY>
        <actionName>FlowLogEntry</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Save_Error_Log</targetReference>
        </connector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <inputParameters>
            <name>flowName</name>
            <value>
                <stringValue>VCC_Appointment_Subflow_CreateAndGoToPN</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>loggingLevelName</name>
            <value>
                <elementReference>LoggingLevel_Error_TextValue</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>message</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputParameters>
        <nameSegment>FlowLogEntry</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <actionCalls>
        <name>Redirect_to_New_Progress_Note</name>
        <label>Redirect to New Progress Note</label>
        <locationX>314</locationX>
        <locationY>1238</locationY>
        <actionName>c:vccRedirectComponent</actionName>
        <actionType>component</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>recId</name>
            <value>
                <elementReference>schedulingProgressNote_var.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>c:vccRedirectComponent</nameSegment>
        <storeOutputAutomatically>true</storeOutputAutomatically>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <actionCalls>
        <name>Save_Error_Log</name>
        <label>Save Error Log</label>
        <locationX>1018</locationX>
        <locationY>1238</locationY>
        <actionName>Logger</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>ErrorScreen</targetReference>
        </connector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <nameSegment>Logger</nameSegment>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <apiVersion>61.0</apiVersion>
    <assignments>
        <description>Reason and Outcome used to document scheduling action
For VCV, Mental Health will be FALSE
Update Status to Open and assign to running User</description>
        <name>Assign_Case_Fields</name>
        <label>Assign Case Fields</label>
        <locationX>50</locationX>
        <locationY>566</locationY>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Case_Reason_Multi__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>CancelAppointmentTextValue</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Case_Outcome_Multi__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>completedSchedulingActionText</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Mental_Health_Appointment__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>No</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>OpenTextValue</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$User.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Case_Reason</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Reason and Outcome used to document scheduling action
For VCV, Mental Health will be FALSE
Update Status to Open and assign to running User</description>
        <name>Assign_Case_Fields_Modify</name>
        <label>Assign Case Fields</label>
        <locationX>578</locationX>
        <locationY>566</locationY>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Case_Reason_Multi__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>ScheduleAppointmentTextValue</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Case_Reason_Multi__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>CancelAppointmentTextValue</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Case_Outcome_Multi__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>completedSchedulingActionText</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.VCC_Mental_Health_Appointment__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>No</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>OpenTextValue</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingCase_var.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$User.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <isGoTo>true</isGoTo>
            <targetReference>Update_Case_Reason</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Create a Scheduling Progress note</description>
        <name>Build_New_Progress_Note</name>
        <label>Build New Progress Note</label>
        <locationX>446</locationX>
        <locationY>914</locationY>
        <assignmentItems>
            <assignToReference>schedulingProgressNote_var.VCC_Case__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>schedulingCase_var.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingProgressNote_var.RecordTypeId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Scheduling_PN_Record_Type.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingProgressNote_var.VCC_Requested_Service__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>vcvAppointmentServiceText</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingProgressNote_var.VCC_Scheduling_Note_Reason2__c</assignToReference>
            <operator>AddItem</operator>
            <value>
                <elementReference>completedSchedulingActionText</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>schedulingProgressNote_var.VCC_Scheduling_Note_Comments__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>PNCommentsText</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Insert_New_Progress_Note</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Decision_Redirect_to_Progress_Note</name>
        <label>Redirect to Progress Note?</label>
        <locationX>446</locationX>
        <locationY>1130</locationY>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes_Go_to_PN</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>RedirectToNewProgressNote_var</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Redirect_to_New_Progress_Note</targetReference>
            </connector>
            <label>Yes - Go to PN</label>
        </rules>
    </decisions>
    <decisions>
        <description>What is the reason for this scheduling action?</description>
        <name>Reason_for_action</name>
        <label>Reason for action?</label>
        <locationX>446</locationX>
        <locationY>458</locationY>
        <defaultConnector>
            <targetReference>Build_New_Progress_Note</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Other/Unknown</defaultConnectorLabel>
        <rules>
            <name>Cancel</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>action_var</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Cancel</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Case_Fields</targetReference>
            </connector>
            <label>Cancel</label>
        </rules>
        <rules>
            <name>Modify</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>action_var</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Modify</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Case_Fields_Modify</targetReference>
            </connector>
            <label>Modify</label>
        </rules>
    </decisions>
    <description>Used to document scheduling actions via a Progress Note when cancelling/modifying a Service Appointment, insert PN, and optionally be redirected to new PN
Pass in Service Appointment Id and query for record to get updated values
- Bug fix CCCM-40075 - Use &quot;No&quot; for VCC_Mental_Health_Appointment__c picklist value</description>
    <environments>Default</environments>
    <formulas>
        <description>Progress Note Comments field needs to be populated with different wording based on type of action.  This formula sets the initial statement based on what action was performed, while the text template includes the rest of the details formatted with line breaks.</description>
        <name>CommentStatementForActionFormula</name>
        <dataType>String</dataType>
        <expression>CASE( {!action_var}, 
&quot;Cancel&quot;, &quot;The VCV service appointment (&quot; &amp; {!serviceAppointment_var.AppointmentNumber} &amp; &quot;) was cancelled for &quot;,
&quot;Modify&quot;, &quot;Canceled the previous appointment and the new VCV service appointment (&quot; &amp; {!serviceAppointment_var.AppointmentNumber} &amp; &quot;) is &quot;,
&quot;VCV service appointment details &quot;
)</expression>
    </formulas>
    <formulas>
        <description>Line breaks in Text Template display the HTML like &lt;p&gt;, where as the formula allows the use of BR() for line breaks
The time is displayed with a Text Template because accessing DateTime field via formula prints it in UTC.</description>
        <name>PNCommentsText</name>
        <dataType>String</dataType>
        <expression>{!CommentStatementForActionFormula} &amp; SUBSTITUTE(SUBSTITUTE({!ScheduledStartTimeDisplayText}, &apos;&lt;p&gt;&apos;, &apos;&apos;), &apos;&lt;/p&gt;&apos;, &apos;&apos;) &amp; &quot;, &quot; &amp; TEXT({!serviceAppointment_var.VCC_Facility_for_Appointment__c}) &amp; &quot;. &quot; &amp; {!ServiceAppointmentCommentsFormula}</expression>
    </formulas>
    <formulas>
        <description>If there are no comments on Serv Appt, leave it blank, otherwise add &apos;Comments: &lt;comments from serv appt&gt;&apos; to carry over to Progress Note</description>
        <name>ServiceAppointmentCommentsFormula</name>
        <dataType>String</dataType>
        <expression>IF(
ISBLANK({!serviceAppointment_var.AppointmentComments__c}), 
&quot;&quot;, 
&quot;Comments: &quot; &amp; {!serviceAppointment_var.AppointmentComments__c}
)</expression>
    </formulas>
    <interviewLabel>VCC_Appointment_Subflow_CreateAndGoToPN {!$Flow.CurrentDateTime}</interviewLabel>
    <label>VCC_Appointment_Subflow_CreateAndGoToPN</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordCreates>
        <name>Insert_New_Progress_Note</name>
        <label>Insert New Progress Note</label>
        <locationX>446</locationX>
        <locationY>1022</locationY>
        <connector>
            <targetReference>Decision_Redirect_to_Progress_Note</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Add_Log_Entry_for_Error</targetReference>
        </faultConnector>
        <inputReference>schedulingProgressNote_var</inputReference>
    </recordCreates>
    <recordLookups>
        <name>Get_Scheduling_PN_Record_Type</name>
        <label>Get Scheduling PN Record Type</label>
        <locationX>446</locationX>
        <locationY>134</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Service_Appointment</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Add_Log_Entry_for_Error</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>VCC_Scheduling_Progress_Note</stringValue>
            </value>
        </filters>
        <filters>
            <field>SobjectType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>VCC_Progress_Note__c</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>RecordType</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Query for the Service Appointment to get the updated values if it was modified (such as new time, facility)</description>
        <name>Get_Service_Appointment</name>
        <label>Get Service Appointment</label>
        <locationX>446</locationX>
        <locationY>242</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Find_or_Create_Scheduling_Case</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Add_Log_Entry_for_Error</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ServiceAppointmentId</elementReference>
            </value>
        </filters>
        <object>ServiceAppointment</object>
        <outputReference>serviceAppointment_var</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>AccountId</queriedFields>
        <queriedFields>SchedStartTime</queriedFields>
        <queriedFields>VCC_Facility_for_Appointment__c</queriedFields>
        <queriedFields>AppointmentComments__c</queriedFields>
        <queriedFields>AppointmentNumber</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Update_Case_Reason</name>
        <label>Update Case Reason</label>
        <locationX>50</locationX>
        <locationY>674</locationY>
        <connector>
            <targetReference>Build_New_Progress_Note</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Add_Log_Entry_for_Error</targetReference>
        </faultConnector>
        <inputReference>schedulingCase_var</inputReference>
    </recordUpdates>
    <screens>
        <name>ErrorScreen</name>
        <label>ErrorScreen</label>
        <locationX>1018</locationX>
        <locationY>1346</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>errorDisplay</name>
            <extensionName>c:vccErrorDisplay</extensionName>
            <fieldType>ComponentInstance</fieldType>
            <inputParameters>
                <name>system</name>
                <value>
                    <elementReference>$Flow.FaultMessage</elementReference>
                </value>
            </inputParameters>
            <inputsOnNextNavToAssocScrn>UseStoredValues</inputsOnNextNavToAssocScrn>
            <isRequired>true</isRequired>
            <storeOutputAutomatically>true</storeOutputAutomatically>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>320</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Scheduling_PN_Record_Type</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <subflows>
        <description>Find existing scheduling case or create a new one</description>
        <name>Find_or_Create_Scheduling_Case</name>
        <label>Find or Create Scheduling Case</label>
        <locationX>446</locationX>
        <locationY>350</locationY>
        <connector>
            <targetReference>Reason_for_action</targetReference>
        </connector>
        <flowName>VCC_Appointment_Subflow_FindOrCreateCase</flowName>
        <inputAssignments>
            <name>accountId_var</name>
            <value>
                <elementReference>serviceAppointment_var.AccountId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>appointmentServiceTextChoice</name>
            <value>
                <elementReference>vcvAppointmentServiceText</elementReference>
            </value>
        </inputAssignments>
        <outputAssignments>
            <assignToReference>schedulingCase_var</assignToReference>
            <name>schedulingCase_var</name>
        </outputAssignments>
    </subflows>
    <textTemplates>
        <description>A formula displays a DateTime field in UTC
Using a Text Template here, displays the time in the user&apos;s time zone</description>
        <name>ScheduledStartTimeDisplayText</name>
        <isViewedAsPlainText>false</isViewedAsPlainText>
        <text>&lt;p&gt;{!serviceAppointment_var.SchedStartTime}&lt;/p&gt;</text>
    </textTemplates>
    <variables>
        <description>Cancel or Modify, passed in from calling Flow</description>
        <name>action_var</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>Text value for Cancel Appointment</description>
        <name>CancelAppointmentTextValue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Cancel Appointment</stringValue>
        </value>
    </variables>
    <variables>
        <description>Text value for Completed Scheduling Action</description>
        <name>completedSchedulingActionText</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Completed Scheduling Action</stringValue>
        </value>
    </variables>
    <variables>
        <name>LoggingLevel_Error_TextValue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>ERROR</stringValue>
        </value>
    </variables>
    <variables>
        <name>OpenTextValue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Open</stringValue>
        </value>
    </variables>
    <variables>
        <description>When True it will redirect user to the Progress Note record page
When appt is cancelled from a list view, this is set to False and user goes back to list view</description>
        <name>RedirectToNewProgressNote_var</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>Text value for Schedule Appointment</description>
        <name>ScheduleAppointmentTextValue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Schedule Appointment</stringValue>
        </value>
    </variables>
    <variables>
        <name>schedulingCase_var</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Case</objectType>
    </variables>
    <variables>
        <name>schedulingProgressNote_var</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <objectType>VCC_Progress_Note__c</objectType>
    </variables>
    <variables>
        <name>serviceAppointment_var</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceAppointment</objectType>
    </variables>
    <variables>
        <name>ServiceAppointmentId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>A text variable for &quot;CCC Virtual Clinic Visit (VCV)&quot;, an picklist value in Case.Appointment Service</description>
        <name>vcvAppointmentServiceText</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>CCC Virtual Clinic Visit (VCV)</stringValue>
        </value>
    </variables>
</Flow>
